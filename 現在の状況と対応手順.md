# WanMap v2 ç¾åœ¨ã®çŠ¶æ³ã¨å¯¾å¿œæ‰‹é †

**æœ€çµ‚æ›´æ–°**: 2025-12-17

---

## ğŸ“Š ç¾åœ¨ã®çŠ¶æ³ã¾ã¨ã‚

### âœ… ä¿®æ­£å®Œäº†ã—ãŸå•é¡Œ

1. **ãƒ”ãƒ³æŠ•ç¨¿æ™‚ã®type 'Null' is not a subtype of type 'String'ã‚¨ãƒ©ãƒ¼**
   - âœ… `RoutePin.fromJson`ã§`route_id`ã‚’`String?`ã«å¤‰æ›´
   - âœ… commit: `34ab340`
   - âœ… GitHubã«ãƒ—ãƒƒã‚·ãƒ¥æ¸ˆã¿

2. **Bottom Sheetæœ€å°åŒ–æ™‚ã®Overflowã‚¨ãƒ©ãƒ¼**
   - âœ… `_minHeight`ã‚’80pxâ†’110pxã«èª¿æ•´
   - âœ… `_buildEmptyState`ã‚’`SingleChildScrollView`ã§ãƒ©ãƒƒãƒ—
   - âœ… commit: `d8f64d4`, `581f058`
   - âœ… GitHubã«ãƒ—ãƒƒã‚·ãƒ¥æ¸ˆã¿

3. **è¿‘ãã®ãŠã™ã™ã‚ãƒ«ãƒ¼ãƒˆãŒè¡¨ç¤ºã•ã‚Œãªã„å•é¡Œï¼ˆä¸€éƒ¨ï¼‰**
   - âœ… `skip(1)`ã‚’å‰Šé™¤ã—ã€å…¨ãƒ«ãƒ¼ãƒˆã‚’Bottom Sheetã«è¡¨ç¤º
   - âœ… æ¤œç´¢ç¯„å›²ã‚’20kmâ†’50kmã«æ‹¡å¤§
   - âœ… ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’è¿½åŠ 
   - âœ… commit: `d8f64d4`, `581f058`
   - âœ… GitHubã«ãƒ—ãƒƒã‚·ãƒ¥æ¸ˆã¿

---

## ğŸš¨ **æœªè§£æ±ºã®å•é¡Œï¼ˆæœ€å„ªå…ˆï¼‰**

### å•é¡Œ1: ãƒ”ãƒ³æŠ•ç¨¿ã¯æˆåŠŸã™ã‚‹ãŒã€HOMEç”»é¢ã«è¡¨ç¤ºã•ã‚Œãªã„

**ã‚¨ãƒ©ãƒ¼å†…å®¹:**
```
PostgrestException(message: column official_routes.title does not exist, code: 42703)
```

**åŸå› :**
- Supabaseã®`get_recent_pins`é–¢æ•°ãŒå¤ã„ã¾ã¾
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å´ã®æ›´æ–°ãŒå¿…è¦

**âœ… è§£æ±ºæ–¹æ³•ï¼ˆå¿…é ˆä½œæ¥­ï¼‰:**

#### æ‰‹é †1: Supabase SQL Editorã«ã‚¢ã‚¯ã‚»ã‚¹

ãƒ–ãƒ©ã‚¦ã‚¶ã§ä»¥ä¸‹ã‚’é–‹ã:
```
https://supabase.com/dashboard/project/jkpenklhrlbctebkpvax/editor
```

#### æ‰‹é †2: æ—¢å­˜ã®é–¢æ•°ã‚’å‰Šé™¤

ä»¥ä¸‹ã®SQLã‚’å®Ÿè¡Œ:

```sql
DROP FUNCTION IF EXISTS get_recent_pins(INT, INT);
```

#### æ‰‹é †3: æ–°ã—ã„é–¢æ•°ã‚’ä½œæˆ

ä»¥ä¸‹ã®SQLã‚’å®Ÿè¡Œ:

```sql
CREATE OR REPLACE FUNCTION get_recent_pins(
  p_limit INT DEFAULT 10,
  p_offset INT DEFAULT 0
)
RETURNS TABLE (
  pin_id UUID,
  route_id UUID,
  route_name TEXT,
  area_id UUID,
  area_name TEXT,
  prefecture TEXT,
  pin_type TEXT,
  title TEXT,
  comment TEXT,
  likes_count INT,
  comments_count INT,
  photo_url TEXT,
  user_id UUID,
  user_name TEXT,
  user_avatar_url TEXT,
  created_at TIMESTAMPTZ,
  pin_lat FLOAT,
  pin_lon FLOAT
)
LANGUAGE plpgsql
AS $$
BEGIN
  RETURN QUERY
  SELECT 
    rp.id AS pin_id,
    rp.route_id,
    official_routes.title AS route_name,
    official_routes.area_id,
    areas.name AS area_name,
    areas.prefecture,
    rp.pin_type,
    rp.title,
    rp.comment,
    rp.likes_count,
    0 AS comments_count,
    (
      SELECT rpp.photo_url
      FROM route_pin_photos rpp
      WHERE rpp.pin_id = rp.id
      ORDER BY rpp.display_order ASC
      LIMIT 1
    ) AS photo_url,
    rp.user_id,
    COALESCE(auth.users.raw_user_meta_data->>'display_name', 'Unknown User') AS user_name,
    COALESCE(auth.users.raw_user_meta_data->>'avatar_url', '') AS user_avatar_url,
    rp.created_at,
    ST_Y(rp.location::geometry) AS pin_lat,
    ST_X(rp.location::geometry) AS pin_lon
  FROM route_pins rp
  LEFT JOIN official_routes ON official_routes.id = rp.route_id
  LEFT JOIN areas ON areas.id = official_routes.area_id
  LEFT JOIN auth.users ON auth.users.id = rp.user_id
  WHERE EXISTS (
    SELECT 1 FROM route_pin_photos rpp WHERE rpp.pin_id = rp.id
  )
  ORDER BY rp.created_at DESC
  LIMIT p_limit
  OFFSET p_offset;
END;
$$;
```

#### æ‰‹é †4: å‹•ä½œç¢ºèª

ä»¥ä¸‹ã®SQLã§ç¢ºèª:

```sql
SELECT * FROM get_recent_pins(2, 0);
```

ã‚¨ãƒ©ãƒ¼ãŒå‡ºãªã‘ã‚Œã°OKï¼ˆãƒ‡ãƒ¼ã‚¿ãŒ0ä»¶ã§ã‚‚å•é¡Œãªã—ï¼‰

#### æ‰‹é †5: Flutterã‚¢ãƒ—ãƒªã§ç¢ºèª

Macå´ã§:
```bash
cd ~/projects/webapp/wanmap_v2
git pull origin main
flutter run
```

---

### å•é¡Œ2: è¿‘ãã®ãŠã™ã™ã‚ãƒ«ãƒ¼ãƒˆãŒ0ä»¶

**ç¾åœ¨ã®çŠ¶æ³:**
- ç¾åœ¨åœ°: `35.25241577122233,139.13942730090932` (ç¥å¥ˆå·çœŒå°ç”°åŸå¸‚ä»˜è¿‘)
- å…¨ãƒ«ãƒ¼ãƒˆæ•°: 13ä»¶
- 50kmä»¥å†…ã®ãƒ«ãƒ¼ãƒˆ: **0ä»¶** â† å•é¡Œ

**åŸå› ï¼ˆæ¨æ¸¬ï¼‰:**
1. ãƒ«ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã®`start_location`ãŒé ã™ãã‚‹
2. ã¾ãŸã¯åº§æ¨™ãƒ‡ãƒ¼ã‚¿ã«å•é¡ŒãŒã‚ã‚‹

**âœ… èª¿æŸ»æ–¹æ³•:**

Supabase SQL Editorã§ä»¥ä¸‹ã‚’å®Ÿè¡Œ:

```sql
-- ç¾åœ¨åœ°ã‹ã‚‰å„ãƒ«ãƒ¼ãƒˆã¾ã§ã®è·é›¢ã‚’è¨ˆç®—
WITH current_location AS (
  SELECT ST_SetSRID(ST_MakePoint(139.13942730090932, 35.25241577122233), 4326)::geography as point
)
SELECT 
  r.id,
  r.title,
  ST_Y(r.start_location::geometry) as start_lat,
  ST_X(r.start_location::geometry) as start_lon,
  ROUND(
    ST_Distance(
      r.start_location,
      (SELECT point FROM current_location)
    )::numeric / 1000,
    2
  ) as distance_km
FROM official_routes r
WHERE r.is_active = TRUE
ORDER BY distance_km ASC
LIMIT 20;
```

**ã“ã®çµæœã‚’ãƒãƒ£ãƒƒãƒˆã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ï¼**

---

## ğŸ“‹ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆå„ªå…ˆé †ä½é †ï¼‰

### âš¡ æœ€å„ªå…ˆï¼ˆä»Šã™ãå®Ÿæ–½ï¼‰

1. **Supabase SQL Editorã§`get_recent_pins`é–¢æ•°ã‚’æ›´æ–°**
   - ä¸Šè¨˜ã®æ‰‹é †1ã€œ4ã‚’å®Ÿè¡Œ
   - ã“ã‚Œã‚’å®Ÿè¡Œã—ãªã„ã¨HOMEç”»é¢ã®ã‚¨ãƒ©ãƒ¼ãŒè§£æ¶ˆã•ã‚Œã¾ã›ã‚“

2. **ãƒ«ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã®è·é›¢èª¿æŸ»SQLã‚’å®Ÿè¡Œ**
   - ä¸Šè¨˜ã®SQLã‚’å®Ÿè¡Œã—ã¦çµæœã‚’ç¢ºèª
   - ãªãœ50kmä»¥å†…ã«0ä»¶ãªã®ã‹ã‚’ç‰¹å®š

3. **Macå´ã§ã‚¢ãƒ—ãƒªã‚’å®Œå…¨å†èµ·å‹•**
   ```bash
   cd ~/projects/webapp/wanmap_v2
   git pull origin main
   flutter clean
   flutter pub get
   flutter run
   ```

### ğŸ” ç¢ºèªé …ç›®

å®Ÿè¡Œå¾Œã€ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„:

#### âœ… HOMEç”»é¢
- [ ] ã€Œæœ€æ–°ã®ãƒ”ãƒ³æŠ•ç¨¿ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã‚¨ãƒ©ãƒ¼ãŒå‡ºãªã„
- [ ] æŠ•ç¨¿ã—ãŸãƒ”ãƒ³ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] æ–°ã—ã„ãƒ”ãƒ³ã‚’æŠ•ç¨¿ã™ã‚‹ã¨å³åº§ã«åæ˜ ã•ã‚Œã‚‹

#### âœ… MAPç”»é¢
- [ ] Bottom SheetãŒæ­£ã—ãå‹•ä½œã™ã‚‹ï¼ˆ110px/300px/500pxï¼‰
- [ ] Bottom Sheetæœ€å°åŒ–æ™‚ã«Overflowã‚¨ãƒ©ãƒ¼ãŒå‡ºãªã„
- [ ] ã€Œè¿‘ãã®ãŠã™ã™ã‚ãƒ«ãƒ¼ãƒˆã€ã«ä½•ä»¶ã‹è¡¨ç¤ºã•ã‚Œã‚‹ï¼ˆç†æƒ³ï¼‰
- [ ] ã¾ãŸã¯ã€Œç¾åœ¨åœ°ã‹ã‚‰50kmä»¥å†…ã«ãŠã™ã™ã‚ãƒ«ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€ã¨è¡¨ç¤ºã•ã‚Œã‚‹

#### âœ… ãƒ­ã‚°ç¢ºèª
Flutterå®Ÿè¡Œæ™‚ã®ãƒ­ã‚°ã§ä»¥ä¸‹ã‚’ç¢ºèª:
```
ğŸ”µ _getRecommendedRoutes: currentLocation=35.252,139.139
ğŸ”µ Total routes: 13
ğŸ”µ Route: â—‹â—‹ã‚³ãƒ¼ã‚¹ at XX.XXX,XXX.XXX - XX.Xkm  â† ã“ã®ãƒ­ã‚°ãŒå‡ºã¦ã„ã‚‹ã‹
ğŸ”µ Total nearby routes (<=50km): X  â† ä½•ä»¶ã‚ã‚‹ã‹
```

---

## ğŸ“‚ é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

### ã‚³ãƒ¼ãƒ‰ã®ä¿®æ­£ç®‡æ‰€
- `lib/models/route_pin.dart` - `route_id`ã®å‹ã‚’String?ã«å¤‰æ›´
- `lib/screens/main/tabs/map_tab.dart` - Bottom Sheetèª¿æ•´ã€æ¤œç´¢ç¯„å›²50km
- `lib/screens/outing/pin_create_screen.dart` - ãƒ”ãƒ³æŠ•ç¨¿å¾Œã®ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å‡¦ç†

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
- `supabase_migrations/009_fix_get_recent_pins_null_route.sql` - ä¿®æ­£ç‰ˆSQL
- Supabase SQL Editorã§æ‰‹å‹•å®Ÿè¡ŒãŒå¿…è¦

### ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- `SUPABASE_FIX_INSTRUCTIONS.md` - Supabaseä¿®æ­£ã®è©³ç´°æ‰‹é †
- `DEBUG_ROUTES_DATA.md` - ãƒ«ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã®ãƒ‡ãƒãƒƒã‚°æ‰‹é †
- `ç¾åœ¨ã®çŠ¶æ³ã¨å¯¾å¿œæ‰‹é †.md` - ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«

---

## ğŸ’¡ ã‚ˆãã‚ã‚‹è³ªå•

### Q1: SQLã‚’å®Ÿè¡Œã—ãŸã®ã«ã‚¨ãƒ©ãƒ¼ãŒç¶šã

**A:** ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„:
1. æ­£ã—ã„Supabaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼ˆjkpenklhrlbctebkpvaxï¼‰ã§å®Ÿè¡Œã—ãŸã‹
2. SQLå®Ÿè¡Œå¾Œã«ã€ŒSuccessã€ã¨è¡¨ç¤ºã•ã‚ŒãŸã‹
3. Flutterã‚¢ãƒ—ãƒªã‚’å®Œå…¨å†èµ·å‹•ã—ãŸã‹ï¼ˆHot Restartã§ã¯ãªãå®Œå…¨åœæ­¢â†’å†å®Ÿè¡Œï¼‰

### Q2: è¿‘ãã®ãƒ«ãƒ¼ãƒˆãŒ0ä»¶ã®ã¾ã¾

**A:** ã“ã‚Œã¯æ­£å¸¸ãªå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ä»¥ä¸‹ã‚’ç¢ºèª:
1. ä¸Šè¨˜ã®è·é›¢èª¿æŸ»SQLã‚’å®Ÿè¡Œ
2. æœ€ã‚‚è¿‘ã„ãƒ«ãƒ¼ãƒˆãŒä½•kmé›¢ã‚Œã¦ã„ã‚‹ã‹ã‚’ç¢ºèª
3. ã‚‚ã—100kmä»¥å†…ã«ãƒ«ãƒ¼ãƒˆãŒã‚ã‚Œã°ã€æ¤œç´¢ç¯„å›²ã‚’æ‹¡å¤§ã™ã‚‹ä¿®æ­£ã‚’ææ¡ˆã—ã¾ã™

### Q3: ãƒ”ãƒ³æŠ•ç¨¿ã¯æˆåŠŸã™ã‚‹ãŒã€ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ä¿å­˜ã•ã‚Œãªã„

**A:** ã“ã‚Œã¯**ä»•æ§˜ã§ã™**ã€‚
- WanMapã¯Supabase Storageã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
- iPhoneã®å†™çœŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ã¯è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã›ã‚“
- SNSã‚¢ãƒ—ãƒªã®ä¸€èˆ¬çš„ãªå‹•ä½œã§ã™

---

## ğŸ¯ ã‚´ãƒ¼ãƒ«

### æœ€çµ‚çš„ã«ç¢ºèªã—ãŸã„çŠ¶æ…‹

1. âœ… ãƒ”ãƒ³æŠ•ç¨¿ãŒæˆåŠŸã™ã‚‹
2. âœ… æŠ•ç¨¿ã—ãŸãƒ”ãƒ³ãŒHOMEç”»é¢ã®ã€Œæœ€æ–°ã®ãƒ”ãƒ³æŠ•ç¨¿ã€ã«å³åº§ã«è¡¨ç¤ºã•ã‚Œã‚‹
3. âœ… MAPç”»é¢ã§Overflowã‚¨ãƒ©ãƒ¼ãŒå‡ºãªã„
4. âœ… MAPç”»é¢ã®Bottom SheetãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹
5. âš ï¸ è¿‘ãã®ãŠã™ã™ã‚ãƒ«ãƒ¼ãƒˆã®è¡¨ç¤ºï¼ˆãƒ‡ãƒ¼ã‚¿æ¬¡ç¬¬ï¼‰

---

## ğŸ“ æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

**ç¯¤å¿—ã•ã‚“ã«ãŠé¡˜ã„ã—ãŸã„ã“ã¨:**

1. **Supabase SQL Editorã§ä¸Šè¨˜ã®SQLã‚’å®Ÿè¡Œ**ï¼ˆæœ€å„ªå…ˆï¼‰
2. **ãƒ«ãƒ¼ãƒˆè·é›¢èª¿æŸ»ã®SQLã‚’å®Ÿè¡Œã—ã¦çµæœã‚’å…±æœ‰**
3. **Macå´ã§git pull & flutter run**
4. **å®Ÿè¡Œçµæœã®ãƒ­ã‚°ã¨ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’å…±æœ‰**

ãã®å¾Œã€æ®‹ã£ã¦ã„ã‚‹å•é¡ŒãŒã‚ã‚Œã°å¯¾å¿œã—ã¾ã™ï¼

---

**ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´æ‰€**: `/home/user/webapp/wanmap_v2/ç¾åœ¨ã®çŠ¶æ³ã¨å¯¾å¿œæ‰‹é †.md`

**GitHub**: ã™ã¹ã¦ã®ä¿®æ­£ã¯pushæ¸ˆã¿
**æœ€æ–°commit**: `451424c`

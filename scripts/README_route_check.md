# 推奨ルートデータ妥当性チェック

TestFlight配信前に、Supabaseに登録されている推奨ルートデータの妥当性をチェックし、おかしいコースを特定・削除するためのスクリプトです。

## 📋 チェック項目

### 🔴 重大な問題（削除推奨）
- **距離データ欠損**: `distance_meters`フィールドが存在しない
- **異常な距離**: 距離が0m以下
- **所要時間データ欠損**: `estimated_minutes`フィールドが存在しない
- **異常な所要時間**: 所要時間が0分以下
- **経路データ欠損**: `path_geojson`フィールドが存在しないか空
- **GeoJSON形式エラー**: typeが'LineString'ではない
- **経路ポイント不足**: 座標が2点未満
- **位置データ欠損**: 開始または終了位置のデータが欠損

### 🟡 警告（確認推奨）
- **距離が異常に長い**: 100km超
- **距離が短すぎる**: 500m未満
- **所要時間が異常に長い**: 10時間超
- **エリア未設定**: `area_id`が設定されていない
- **開始・終了位置が同じ**: 開始位置と終了位置が同じで距離が短い

### 🔵 情報（任意対応）
- **ループコース**: 開始位置と終了位置が同じ（1km以上のループは正常）
- **説明文不足**: 説明文が短すぎるか存在しない

## 🚀 使い方

### 1. 必要なモジュールをインストール

```bash
pip3 install requests
```

### 2. 環境変数を設定

Supabaseの認証情報を環境変数に設定します。

**方法A: ターミナルで直接設定（一時的）**

```bash
export SUPABASE_URL='https://your-project-id.supabase.co'
export SUPABASE_KEY='your-anon-key-here'
```

**方法B: .envファイルから読み込み（推奨）**

`.env`ファイルがあれば、以下のコマンドで環境変数を読み込めます：

```bash
# .envファイルの内容を環境変数にロード
export $(grep -v '^#' .env | xargs)
```

### 3. スクリプトを実行

```bash
cd /Users/atsushinarisawa/projects/webapp/wanmap_v2
python3 scripts/check_routes.py
```

## 📊 出力例

```
📡 Supabaseから推奨ルートデータを取得中...
✅ 15件の推奨ルートを取得しました

================================================================================
📊 推奨ルート妥当性チェック結果
================================================================================

📈 総ルート数: 15
🔴 重大な問題: 3件
🟡 警告: 2件
🔵 情報: 1件
✅ 問題なし: 9件

--------------------------------------------------------------------------------
🔴 重大な問題（削除推奨）
--------------------------------------------------------------------------------

🔴 [CRITICAL] テストルート1 (abc123)
   → 距離データ欠損: distance_metersフィールドが存在しません

🔴 [CRITICAL] 無名ルート (xyz789)
   → 経路データ欠損: path_geojsonフィールドが存在しないか空です

--------------------------------------------------------------------------------
🟡 警告（確認推奨）
--------------------------------------------------------------------------------

🟡 [WARNING] 箱根芦ノ湖一周 (def456)
   → 距離が異常に長い: 距離が100kmを超えています: 120.5km

================================================================================
🗑️ 削除推奨ルートID一覧
================================================================================
  - abc123
  - xyz789

💡 削除SQLスクリプト:
--------------------------------------------------------------------------------
-- 重大な問題のあるルートを削除
DELETE FROM recommended_routes WHERE id = 'abc123';
DELETE FROM recommended_routes WHERE id = 'xyz789';

================================================================================
✅ チェック完了
================================================================================
```

## 🗑️ おかしいルートの削除方法

### 方法1: Supabase Dashboard（推奨）

1. Supabase Dashboardにログイン
2. 左メニューから「Table Editor」を選択
3. `recommended_routes`テーブルを開く
4. 削除したいルートの行を選択して削除

### 方法2: SQL Editorで削除

1. Supabase Dashboardにログイン
2. 左メニューから「SQL Editor」を選択
3. スクリプトが出力した削除SQLをコピー&ペースト
4. 実行

```sql
-- 例: 重大な問題のあるルートを削除
DELETE FROM recommended_routes WHERE id = 'abc123';
DELETE FROM recommended_routes WHERE id = 'xyz789';
```

## 📝 注意事項

- **バックアップ推奨**: 削除前に必ずデータのバックアップを取ってください
- **本番環境での実行**: 本番Supabaseに対して実行する場合は注意してください
- **削除の影響**: ルートを削除すると、そのルートに紐づく散歩記録やピン投稿も影響を受ける可能性があります

## 🔧 トラブルシューティング

### エラー: `requests`モジュールがない

```bash
pip3 install requests
```

### エラー: 環境変数が設定されていない

```bash
export SUPABASE_URL='https://your-project-id.supabase.co'
export SUPABASE_KEY='your-anon-key-here'
```

### エラー: Supabaseへの接続失敗

- SUPABASE_URLが正しいか確認
- SUPABASE_KEYが正しいか確認（anon keyまたはservice role key）
- インターネット接続を確認

## 📌 次のステップ

1. スクリプトを実行して問題のあるルートを特定
2. 重大な問題のあるルート（🔴）を削除
3. 警告レベルのルート（🟡）を確認・修正または削除
4. TestFlight配信準備を継続

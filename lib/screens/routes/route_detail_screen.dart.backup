import 'package:flutter/material.dart';
import 'package:flutter_map/flutter_map.dart';
import 'package:latlong2/latlong.dart';
import '../../models/route_model.dart';
import '../../services/route_service.dart';

/// ルート詳細画面
class RouteDetailScreen extends StatefulWidget {
  final String routeId;

  const RouteDetailScreen({
    super.key,
    required this.routeId,
  });

  @override
  State<RouteDetailScreen> createState() => _RouteDetailScreenState();
}

class _RouteDetailScreenState extends State<RouteDetailScreen> {
  RouteModel? _route;
  bool _isLoading = true;
  String? _errorMessage;
  final MapController _mapController = MapController();

  @override
  void initState() {
    super.initState();
    _loadRouteDetail();
  }

  /// ルート詳細を読み込む
  Future<void> _loadRouteDetail() async {
    setState(() {
      _isLoading = true;
      _errorMessage = null;
    });

    try {
      final route = await RouteService().getRouteDetail(widget.routeId);
      
      if (route == null) {
        setState(() {
          _errorMessage = 'ルートが見つかりませんでした';
          _isLoading = false;
        });
        return;
      }

      setState(() {
        _route = route;
        _isLoading = false;
      });

      // 地図をルート全体が見えるように調整
      if (route.points.isNotEmpty) {
        _fitMapToBounds(route.points.map((p) => p.latLng).toList());
      }
    } catch (e) {
      setState(() {
        _errorMessage = 'エラーが発生しました: $e';
        _isLoading = false;
      });
    }
  }

  /// 地図をルート全体が見えるように調整
  void _fitMapToBounds(List<LatLng> points) {
    if (points.isEmpty) return;

    // 最小・最大の緯度経度を取得
    double minLat = points.first.latitude;
    double maxLat = points.first.latitude;
    double minLng = points.first.longitude;
    double maxLng = points.first.longitude;

    for (final point in points) {
      if (point.latitude < minLat) minLat = point.latitude;
      if (point.latitude > maxLat) maxLat = point.latitude;
      if (point.longitude < minLng) minLng = point.longitude;
      if (point.longitude > maxLng) maxLng = point.longitude;
    }

    // 境界を少し広げる（10%のマージン）
    final latMargin = (maxLat - minLat) * 0.1;
    final lngMargin = (maxLng - minLng) * 0.1;

    final bounds = LatLngBounds(
      LatLng(minLat - latMargin, minLng - lngMargin),
      LatLng(maxLat + latMargin, maxLng + lngMargin),
    );

    // 地図を境界に合わせる（少し遅延させて確実に反映）
    Future.delayed(const Duration(milliseconds: 100), () {
      if (mounted) {
        _mapController.fitCamera(
          CameraFit.bounds(
            bounds: bounds,
            padding: const EdgeInsets.all(50),
          ),
        );
      }
    });
  }

  /// 削除確認ダイアログを表示
  Future<void> _showDeleteDialog() async {
    final result = await showDialog<bool>(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('ルートを削除'),
        content: const Text('このルートを削除してもよろしいですか？\nこの操作は取り消せません。'),
        actions: [
          TextButton(
            onPressed: () => Navigator.of(context).pop(false),
            child: const Text('キャンセル'),
          ),
          TextButton(
            onPressed: () => Navigator.of(context).pop(true),
            style: TextButton.styleFrom(foregroundColor: Colors.red),
            child: const Text('削除'),
          ),
        ],
      ),
    );

    if (result == true && mounted) {
      await _deleteRoute();
    }
  }

  /// ルートを削除
  Future<void> _deleteRoute() async {
    if (_route == null) return;

    // ローディング表示
    if (!mounted) return;
    ScaffoldMessenger.of(context).showSnackBar(
      const SnackBar(content: Text('削除中...')),
    );

    try {
      final user = await RouteService().deleteRoute(
        _route!.id!,
        _route!.userId,
      );

      if (!mounted) return;

      if (user) {
        // 成功メッセージを表示
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Text('ルートを削除しました'),
            backgroundColor: Colors.green,
          ),
        );

        // ルート一覧画面に戻る
        Navigator.of(context).pop(true);
      } else {
        // 失敗メッセージを表示
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Text('削除に失敗しました'),
            backgroundColor: Colors.red,
          ),
        );
      }
    } catch (e) {
      if (!mounted) return;
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('エラー: $e'),
          backgroundColor: Colors.red,
        ),
      );
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text(_route?.title ?? 'ルート詳細'),
          actions: [
          // 削除ボタン
          IconButton(
            icon: const Icon(Icons.delete_outline),
            onPressed: _route != null ? () => _showDeleteDialog() : null,
          ),
        ],
      ),
      body: _isLoading
          ? const Center(child: CircularProgressIndicator())
          : _errorMessage != null
              ? Center(
                  child: Column(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      const Icon(Icons.error_outline, size: 64, color: Colors.red),
                      const SizedBox(height: 16),
                      Text(_errorMessage!),
                      const SizedBox(height: 16),
                      ElevatedButton(
                        onPressed: _loadRouteDetail,
                        child: const Text('再読み込み'),
                      ),
                    ],
                  ),
                )
              : _route == null
                  ? const Center(child: Text('ルートが見つかりませんでした'))
                  : Column(
                      children: [
                        // 地図表示
                        Expanded(
                          flex: 2,
                          child: FlutterMap(
                            mapController: _mapController,
                            options: MapOptions(
                              initialCenter: _route!.points.isNotEmpty
                                  ? _route!.points.first.latLng
                                  : const LatLng(35.6762, 139.6503),
                              initialZoom: 14.0,
                              minZoom: 3.0,
                              maxZoom: 18.0,
                            ),
                            children: [
                              // OpenStreetMapタイル
                              TileLayer(
                                urlTemplate: 'https://tile.openstreetmap.org/{z}/{x}/{y}.png',
                                userAgentPackageName: 'com.example.wanmap_v2',
                              ),
                              // ルートの軌跡（赤い線）
                              if (_route!.points.isNotEmpty)
                                PolylineLayer(
                                  polylines: [
                                    Polyline(
                                      points: _route!.points.map((p) => p.latLng).toList(),
                                      color: Colors.red,
                                      strokeWidth: 4.0,
                                    ),
                                  ],
                                ),
                              // マーカー（開始地点と終了地点）
                              if (_route!.points.isNotEmpty)
                                MarkerLayer(
                                  markers: [
                                    // 開始地点（緑）
                                    Marker(
                                      point: _route!.points.first.latLng,
                                      width: 40,
                                      height: 40,
                                      child: const Icon(
                                        Icons.play_circle,
                                        color: Colors.green,
                                        size: 40,
                                      ),
                                    ),
                                    // 終了地点（赤）
                                    Marker(
                                      point: _route!.points.last.latLng,
                                      width: 40,
                                      height: 40,
                                      child: const Icon(
                                        Icons.stop_circle,
                                        color: Colors.red,
                                        size: 40,
                                      ),
                                    ),
                                  ],
                                ),
                            ],
                          ),
                        ),
                        // ルート情報
                        Expanded(
                          flex: 1,
                          child: SingleChildScrollView(
                            padding: const EdgeInsets.all(16),
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                // タイトル
                                Text(
                                  _route!.title,
                                  style: const TextStyle(
                                    fontSize: 24,
                                    fontWeight: FontWeight.bold,
                                  ),
                                ),
                                const SizedBox(height: 8),
                                
                                // 説明
                                if (_route!.description != null && _route!.description!.isNotEmpty)
                                  Padding(
                                    padding: const EdgeInsets.only(bottom: 16),
                                    child: Text(
                                      _route!.description!,
                                      style: TextStyle(
                                        fontSize: 16,
                                        color: Colors.grey[700],
                                      ),
                                    ),
                                  ),
                                
                                // 統計情報カード
                                Card(
                                  child: Padding(
                                    padding: const EdgeInsets.all(16),
                                    child: Column(
                                      children: [
                                        _StatRow(
                                          icon: Icons.straighten,
                                          label: '距離',
                                          value: '${(_route!.distance / 1000).toStringAsFixed(2)} km',
                                        ),
                                        const Divider(),
                                        _StatRow(
                                          icon: Icons.timer,
                                          label: '時間',
                                          value: _route!.formatDuration(),
                                        ),
                                        const Divider(),
                                        _StatRow(
                                          icon: Icons.speed,
                                          label: '平均速度',
                                          value: _route!.duration > 0
                                              ? '${((_route!.distance / 1000) / (_route!.duration / 3600)).toStringAsFixed(1)} km/h'
                                              : '0 km/h',
                                        ),
                                        const Divider(),
                                        _StatRow(
                                          icon: Icons.calendar_today,
                                          label: '日付',
                                          value: _route!.formatDate(),
                                        ),
                                        const Divider(),
                                        _StatRow(
                                          icon: Icons.location_on,
                                          label: 'GPS点数',
                                          value: '${_route!.points.length} 点',
                                        ),
                                      ],
                                    ),
                                  ),
                                ),
                              ],
                            ),
                          ),
                        ),
                      ],
                    ),
    );
  }
}

/// 統計情報の行
class _StatRow extends StatelessWidget {
  final IconData icon;
  final String label;
  final String value;

  const _StatRow({
    required this.icon,
    required this.label,
    required this.value,
  });

  @override
  Widget build(BuildContext context) {
    return Row(
      children: [
        Icon(icon, size: 24, color: Colors.blue),
        const SizedBox(width: 12),
        Expanded(
          child: Text(
            label,
            style: const TextStyle(
              fontSize: 16,
              fontWeight: FontWeight.w500,
            ),
          ),
        ),
        Text(
          value,
          style: const TextStyle(
            fontSize: 16,
            fontWeight: FontWeight.bold,
          ),
        ),
      ],
    );
  }
}

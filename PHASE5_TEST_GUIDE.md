# Phase 5 テストガイド

## 📋 目次
1. [テスト準備](#テスト準備)
2. [Phase 5-1: ルート検索・フィルター](#phase-5-1-ルート検索フィルター)
3. [Phase 5-2: お気に入り・ブックマーク](#phase-5-2-お気に入りブックマーク)
4. [Phase 5-3: ユーザー統計](#phase-5-3-ユーザー統計)
5. [Phase 5-4: ソーシャル機能](#phase-5-4-ソーシャル機能)
6. [Phase 5-5: バッジシステム](#phase-5-5-バッジシステム)
7. [統合テスト](#統合テスト)
8. [既知の問題](#既知の問題)

---

## テスト準備

### 1. データベースマイグレーション

Phase 5の全機能を使用するには、以下のマイグレーションが必要です:

```bash
# Phase 5マイグレーション (search & social)
# supabase_migrations/007_phase5_search_and_social.sql

# Phase 5マイグレーション (badges system)
# supabase_migrations/008_phase5_badges_system.sql
```

**Supabase Dashboardでの実行手順:**
1. Supabase Dashboard → SQL Editor に移動
2. `007_phase5_search_and_social.sql` の内容を貼り付けて実行
3. `008_phase5_badges_system.sql` の内容を貼り付けて実行
4. エラーがないことを確認

### 2. テストデータの作成

**重要:** テストデータスクリプトを実行する前に、以下の手順でユーザーIDを取得してください:

1. アプリから3つのテストアカウントを作成:
   - `test1@example.com` (散歩マスター)
   - `test2@example.com` (バッジコレクター)
   - `test3@example.com` (ソーシャルユーザー)

2. Supabase Dashboard → Authentication → Users から各ユーザーのUUIDをコピー

3. `supabase_migrations/test_data_phase5.sql` を開き、以下の行を実際のUUIDに置き換え:
   ```sql
   user1_id UUID := 'ACTUAL_UUID_FOR_TEST1';
   user2_id UUID := 'ACTUAL_UUID_FOR_TEST2';
   user3_id UUID := 'ACTUAL_UUID_FOR_TEST3';
   ```

4. Supabase Dashboard → SQL Editorで修正したスクリプトを実行

### 3. アプリのビルドと起動

```bash
cd wanmap_v2
flutter pub get
flutter run
```

---

## Phase 5-1: ルート検索・フィルター

### 機能概要
- 公式ルートの検索（テキスト検索）
- 8種類のフィルター適用
- ソート機能（人気順、距離、評価、新着）
- 無限スクロール（20件/ページ）
- お気に入り登録/解除

### テストシナリオ

#### 1. ルート検索画面へのアクセス
**手順:**
1. ホーム画面から検索アイコンをタップ
2. ルート検索画面が表示されることを確認

**期待結果:**
- ✅ 検索バーが表示される
- ✅ ソートチップが表示される（人気順、距離↑、距離↓、評価、新着）
- ✅ フィルターボタンが表示される
- ✅ 初期状態で全ルートが人気順に表示される

#### 2. テキスト検索
**手順:**
1. 検索バーに「公園」と入力
2. 検索結果が動的に更新されることを確認

**期待結果:**
- ✅ 入力中にリアルタイムで結果が更新される
- ✅ 「公園」を含むルートのみが表示される
- ✅ 検索結果件数が表示される

#### 3. フィルター適用
**手順:**
1. フィルターボタンをタップ
2. フィルターボトムシートが開く
3. 以下のフィルターを設定:
   - 難易度: 初心者向け
   - 距離: 2km ~ 5km
   - エリア: 渋谷区
4. 「適用」ボタンをタップ

**期待結果:**
- ✅ フィルターボトムシートが表示される
- ✅ 各フィルターが正しく動作する
- ✅ 適用後、条件に合うルートのみ表示される
- ✅ フィルターボタンにバッジ（適用中フィルター数）が表示される

#### 4. ソート変更
**手順:**
1. 「距離↑」チップをタップ
2. 結果が距離の昇順に並び替わることを確認
3. 「評価」チップをタップ
4. 結果が評価順に並び替わることを確認

**期待結果:**
- ✅ 選択中のチップがハイライトされる
- ✅ ソート順に応じて結果が並び替わる

#### 5. 無限スクロール
**手順:**
1. 検索結果を下にスクロール
2. 80%に達すると次のページが読み込まれる

**期待結果:**
- ✅ スクロール時にローディングインジケーターが表示される
- ✅ 追加のルートが読み込まれる
- ✅ 重複なく表示される

#### 6. お気に入り登録/解除
**手順:**
1. 任意のルートカードのハートアイコンをタップ
2. お気に入りに追加される
3. もう一度タップしてお気に入りを解除

**期待結果:**
- ✅ タップ時にハートアイコンが塗りつぶされる
- ✅ お気に入り数が1増加する
- ✅ 解除時にハートアイコンが元に戻る
- ✅ お気に入り数が1減少する

---

## Phase 5-2: お気に入り・ブックマーク

### 機能概要
- お気に入りルート一覧表示
- ブックマークピン一覧表示
- タブ切り替え（ルート/ピン）
- 無限スクロール
- Pull-to-refresh

### テストシナリオ

#### 1. お気に入り画面へのアクセス
**手順:**
1. ホーム画面から「保存済み」タブをタップ

**期待結果:**
- ✅ 2つのタブが表示される（ルート、ピン）
- ✅ デフォルトで「ルート」タブが選択されている

#### 2. お気に入りルート表示
**手順:**
1. 「ルート」タブを確認
2. お気に入りに追加したルートが表示されることを確認

**期待結果:**
- ✅ お気に入りに追加したルートが表示される
- ✅ 各ルートカードに基本情報が表示される（名前、距離、難易度、エリア）
- ✅ お気に入り日時が表示される

#### 3. ブックマークピン表示
**手順:**
1. 「ピン」タブをタップ
2. ブックマークしたピンが表示されることを確認

**期待結果:**
- ✅ ブックマークしたピンが表示される
- ✅ 各ピンカードに基本情報が表示される（名前、タイプ、エリア、作成者）
- ✅ ブックマーク日時が表示される

#### 4. Pull-to-refresh
**手順:**
1. 画面を下に引っ張る
2. 手を離す
3. データが再読み込みされることを確認

**期待結果:**
- ✅ リフレッシュインジケーターが表示される
- ✅ データが最新の状態に更新される

#### 5. ルート/ピン詳細への遷移
**手順:**
1. 任意のルート/ピンカードをタップ
2. 詳細画面に遷移することを確認

**期待結果:**
- ✅ タップ時に詳細画面に遷移する
- ✅ 戻るボタンで元の画面に戻れる

---

## Phase 5-3: ユーザー統計

### 機能概要
- ユーザーレベル表示
- 総距離、総散歩回数、訪問エリア数、作成ピン数
- レベル進捗バー
- バッジ統計

### テストシナリオ

#### 1. プロフィール画面から統計確認
**手順:**
1. ホーム画面 → プロフィールボタンをタップ
2. プロフィール画面が表示される
3. 統計情報カードを確認

**期待結果:**
- ✅ 総ルート数が表示される
- ✅ 総距離が表示される（km/m単位）
- ✅ 総時間が表示される（時間分）

#### 2. 統計ダッシュボードへのアクセス
**手順:**
1. プロフィール画面から「統計ダッシュボード」をタップ
2. 統計ダッシュボード画面が表示される

**期待結果:**
- ✅ レベルカードが表示される
- ✅ 現在のレベルと次のレベルが表示される
- ✅ 経験値バーが表示される
- ✅ 統計グリッドが表示される（距離、散歩回数、エリア、ピン）

#### 3. レベル計算の確認
**手順:**
1. レベルカードを確認
2. 総距離から計算されたレベルが正しいか確認（10kmごとに1レベル）

**期待結果:**
- ✅ レベルが正しく計算されている
- ✅ 経験値バーが0.0 ~ 1.0の範囲で表示される
- ✅ 次のレベルまでの進捗が正確に表示される

#### 4. バッジサマリー
**手順:**
1. 統計ダッシュボードのバッジサマリーカードを確認
2. 「バッジを見る」ボタンをタップ

**期待結果:**
- ✅ 獲得済みバッジ数が表示される
- ✅ 達成率（パーセンテージ）が表示される
- ✅ 進捗バーが表示される
- ✅ タップでバッジ一覧画面に遷移する

#### 5. 最近獲得したバッジ
**手順:**
1. 統計ダッシュボードの「最近獲得したバッジ」セクションを確認

**期待結果:**
- ✅ 最新3件の獲得バッジが表示される
- ✅ バッジアイコン、名前、ティア、獲得日時が表示される
- ✅ 獲得日時が相対表示される（「3時間前」など）

---

## Phase 5-4: ソーシャル機能

### 機能概要
- ユーザー検索
- フォロー/アンフォロー
- フォロワー/フォロー中一覧
- タイムライン（フォロー中のピン）
- リアルタイム通知

### テストシナリオ

#### 1. ユーザー検索
**手順:**
1. プロフィール画面 → ユーザー検索アイコンをタップ
2. 検索バーに「test」と入力

**期待結果:**
- ✅ 検索バーが表示される
- ✅ リアルタイムで検索結果が表示される
- ✅ ユーザーカードにアバター、表示名、フォロワー数が表示される

#### 2. ユーザープロフィール表示
**手順:**
1. 検索結果から任意のユーザーをタップ
2. ユーザープロフィール画面が表示される

**期待結果:**
- ✅ アバター画像が表示される
- ✅ 表示名、自己紹介が表示される
- ✅ フォロワー数/フォロー中数が表示される（タップ可能）
- ✅ フォローボタンが表示される
- ✅ 統計情報が表示される

#### 3. フォロー/アンフォロー
**手順:**
1. ユーザープロフィール画面でフォローボタンをタップ
2. ボタンが「フォロー中」に変わることを確認
3. もう一度タップしてアンフォロー

**期待結果:**
- ✅ フォロー時にボタンが「フォロー中」に変わる
- ✅ フォロワー数が1増加する
- ✅ 相手に通知が送信される
- ✅ アンフォロー時にボタンが「フォロー」に戻る
- ✅ フォロワー数が1減少する

#### 4. フォロワー/フォロー中一覧
**手順:**
1. ユーザープロフィール画面でフォロワー数をタップ
2. フォロワー一覧が表示される
3. 戻って、フォロー中数をタップ
4. フォロー中一覧が表示される

**期待結果:**
- ✅ フォロワー一覧が表示される
- ✅ フォロー中一覧が表示される
- ✅ 各ユーザーカードに基本情報とフォロー状態が表示される

#### 5. 通知センター
**手順:**
1. ホーム画面 → 通知アイコンをタップ
2. 通知一覧が表示される

**期待結果:**
- ✅ 通知が新しい順に表示される
- ✅ 未読通知がハイライトされる
- ✅ 通知タイプごとにアイコンが異なる
- ✅ 相対時刻が表示される（「3時間前」など）

#### 6. 通知のインタラクション
**手順:**
1. 通知をタップして関連画面に遷移
2. 通知を左にスワイプして削除
3. 「すべて既読にする」ボタンをタップ

**期待結果:**
- ✅ タップ時に関連画面に遷移する
- ✅ スワイプで削除できる
- ✅ 「すべて既読にする」で全通知が既読になる
- ✅ 未読バッジが消える

#### 7. リアルタイム通知
**手順:**
1. 2台の端末を用意
2. 端末Aでユーザー1でログイン
3. 端末Bでユーザー2でログイン
4. 端末Bからユーザー1をフォロー

**期待結果:**
- ✅ 端末Aでリアルタイムに通知が表示される
- ✅ 通知バッジが更新される
- ✅ SnackBarまたはダイアログで新着通知が表示される

---

## Phase 5-5: バッジシステム

### 機能概要
- バッジコレクション一覧（カテゴリ別タブ）
- バッジ詳細表示（ロック/アンロック状態）
- バッジ統計（獲得数、達成率）
- バッジ解除チェック（散歩完了時）

### テストシナリオ

#### 1. バッジ一覧画面へのアクセス
**手順:**
1. プロフィール画面 → 「バッジコレクション」をタップ
2. バッジ一覧画面が表示される

**期待結果:**
- ✅ 5つのカテゴリタブが表示される（距離、エリア、ピン、ソーシャル、特別）
- ✅ ヘッダーに統計情報が表示される（獲得数、全バッジ数、達成率）
- ✅ 進捗バーが表示される

#### 2. カテゴリ別バッジ表示
**手順:**
1. 各カテゴリタブをタップして確認
2. バッジが2列のグリッドで表示されることを確認

**期待結果:**
- ✅ 各カテゴリに適切なバッジが表示される
- ✅ 獲得済みバッジが上に表示される
- ✅ ロック中のバッジがグレーアウトされる

#### 3. バッジカード表示
**手順:**
1. 獲得済みバッジと未獲得バッジを比較

**獲得済みバッジの期待結果:**
- ✅ カラフルなアイコンが表示される
- ✅ ティアカラーのグラデーションが表示される
- ✅ バッジ名、ティア、説明が表示される
- ✅ 獲得日時が表示される

**未獲得バッジの期待結果:**
- ✅ グレーアウトされたアイコンが表示される
- ✅ 「ロック中」と表示される
- ✅ 説明は表示されるが薄い色

#### 4. ティア別カラー確認
**手順:**
1. 各ティアのバッジを確認:
   - ブロンズ（銅色）
   - シルバー（銀色）
   - ゴールド（金色）
   - プラチナ（プラチナ色）

**期待結果:**
- ✅ ティアごとに異なる色が適用される
- ✅ アイコンの枠とティアラベルが同じ色

#### 5. Pull-to-refresh
**手順:**
1. バッジ一覧画面を下に引っ張る
2. 手を離す
3. データが再読み込みされる

**期待結果:**
- ✅ リフレッシュインジケーターが表示される
- ✅ 新しく獲得したバッジがある場合、表示が更新される

#### 6. バッジ解除の自動チェック
**手順:**
1. 散歩を完了する
2. バッジ解除条件を満たす（例: 10km達成）
3. バッジが自動的に解除される

**期待結果:**
- ✅ 散歩完了時に自動的にバッジチェックが実行される
- ✅ 条件を満たした場合、バッジが解除される
- ✅ バッジ獲得通知が表示される（SnackBarまたはDialog）
- ✅ 通知センターに「badge_unlocked」通知が追加される

#### 7. 特別バッジの確認
**手順:**
1. 「特別」タブを開く
2. 以下のバッジを確認:
   - first_walk（初めての散歩）
   - first_pin（初めてのピン作成）
   - early_adopter（早期利用者）

**期待結果:**
- ✅ 特別バッジが表示される
- ✅ 条件を満たした場合、自動的に解除される

---

## 統合テスト

### エンドツーエンドシナリオ

#### シナリオ1: 新規ユーザーのオンボーディング
1. アカウント作成
2. プロフィール設定
3. 初めての散歩（first_walk バッジ獲得）
4. 初めてのピン作成（first_pin バッジ獲得）
5. 統計ダッシュボードで進捗確認

#### シナリオ2: ソーシャル交流
1. 他のユーザーを検索
2. フォローする
3. フォロワーの新しいピンを発見
4. ピンをブックマーク
5. 通知を確認

#### シナリオ3: バッジコレクション
1. 複数の散歩を完了（距離を積み重ねる）
2. 複数のエリアを訪問
3. 複数のピンを作成
4. バッジ一覧で進捗確認
5. 次のバッジ目標を確認

---

## 既知の問題

### 1. テストデータスクリプトの制限
- **問題:** `auth.users` テーブルは手動で作成できない
- **回避策:** アプリから実際にアカウントを作成し、UUIDを取得してスクリプトを修正

### 2. リアルタイム通知の遅延
- **問題:** Supabase Realtimeの接続が不安定な場合、通知が遅延することがある
- **回避策:** ネットワーク接続を確認し、アプリを再起動

### 3. バッジ解除チェックのタイミング
- **問題:** 散歩完了時のバッジチェックが実装されていない場合、手動で `check_and_unlock_badges` RPC を呼び出す必要がある
- **回避策:** `badge_unlock_helper.dart` の `checkAndUnlockBadges` 関数を散歩完了処理に統合

### 4. 統計情報の更新遅延
- **問題:** RLS (Row Level Security) により、統計情報の更新がリアルタイムでない場合がある
- **回避策:** Pull-to-refreshで手動更新

---

## テスト完了チェックリスト

### Phase 5-1: ルート検索・フィルター
- [ ] テキスト検索が動作する
- [ ] 8種類のフィルターが全て動作する
- [ ] ソート機能が動作する
- [ ] 無限スクロールが動作する
- [ ] お気に入り登録/解除が動作する

### Phase 5-2: お気に入り・ブックマーク
- [ ] お気に入りルート一覧が表示される
- [ ] ブックマークピン一覧が表示される
- [ ] タブ切り替えが動作する
- [ ] Pull-to-refreshが動作する

### Phase 5-3: ユーザー統計
- [ ] プロフィール画面の統計が表示される
- [ ] 統計ダッシュボードが表示される
- [ ] レベルと経験値が正しく計算される
- [ ] バッジサマリーが表示される

### Phase 5-4: ソーシャル機能
- [ ] ユーザー検索が動作する
- [ ] フォロー/アンフォローが動作する
- [ ] フォロワー/フォロー中一覧が表示される
- [ ] 通知センターが動作する
- [ ] リアルタイム通知が動作する

### Phase 5-5: バッジシステム
- [ ] バッジ一覧が表示される
- [ ] カテゴリ別タブが動作する
- [ ] バッジカードが正しく表示される
- [ ] ティア別カラーが適用される
- [ ] バッジ統計が表示される
- [ ] バッジ解除チェックが動作する

### 統合テスト
- [ ] エンドツーエンドシナリオが全て完了する
- [ ] パフォーマンスが許容範囲内
- [ ] エラーハンドリングが適切

---

## 次のステップ

Phase 5のテストが完了したら:

1. **バグ修正**: 発見された問題を修正
2. **パフォーマンス最適化**: 重いクエリやUI遅延の改善
3. **ユーザーフィードバック収集**: 実際のユーザーから意見を集める
4. **Phase 6の計画**: 次のフェーズの機能を設計

---

## サポート

テスト中に問題が発生した場合:

1. コンソールログを確認
2. Supabase Dashboardでデータを確認
3. 該当するRPC関数を直接テスト
4. 必要に応じて開発チームに報告

Happy Testing! 🎉

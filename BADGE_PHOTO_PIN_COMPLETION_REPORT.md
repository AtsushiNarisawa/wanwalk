# Badgeãƒ»å†™çœŸãƒ»ãƒ”ãƒ³æ©Ÿèƒ½ å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆ

**æ—¥ä»˜:** 2025-11-27  
**ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ:** wanmap_v2  
**æ‹…å½“:** AI Assistant (è‡ªå‹•å®Ÿè¡Œ)

---

## ğŸ“‹ **æ¦‚è¦**

Badgeæ©Ÿèƒ½ã€å†™çœŸæ©Ÿèƒ½ã€ãƒ”ãƒ³æŠ•ç¨¿æ©Ÿèƒ½ã®å®Ÿè£…çŠ¶æ³ã‚’ç¢ºèªã—ã€ä¸è¶³ã—ã¦ã„ãŸBadgeè‡ªå‹•ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚

---

## ğŸ† **Badgeæ©Ÿèƒ½**

### **æ—¢å­˜å®Ÿè£…ï¼ˆç¢ºèªæ¸ˆã¿ï¼‰:**
- âœ… `badge_definitions` ãƒ†ãƒ¼ãƒ–ãƒ«
- âœ… `user_badges` ãƒ†ãƒ¼ãƒ–ãƒ«
- âœ… `check_and_unlock_badges` RPCé–¢æ•°
- âœ… `BadgeService` (å®Œå…¨å®Ÿè£…)
- âœ… `BadgeProvider` (Riverpod)
- âœ… `BadgeCard` ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆ

### **æ–°è¦è¿½åŠ :**
âœ… **æ•£æ­©ä¿å­˜å¾Œã®è‡ªå‹•ãƒãƒƒã‚¸ãƒã‚§ãƒƒã‚¯**

#### **ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«:**
1. `lib/screens/daily/daily_walking_screen.dart`
2. `lib/screens/outing/walking_screen.dart`

#### **è¿½åŠ å†…å®¹:**
```dart
// BadgeService importè¿½åŠ 
import '../../services/badge_service.dart';

// ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–°å¾Œã«ãƒãƒƒã‚¸ãƒã‚§ãƒƒã‚¯
// 4. ãƒãƒƒã‚¸è§£é™¤ãƒã‚§ãƒƒã‚¯
final badgeService = BadgeService(Supabase.instance.client);
final newBadges = await badgeService.checkAndUnlockBadges(userId: userId);
if (newBadges.isNotEmpty && mounted) {
  if (kDebugMode) {
    print('ğŸ† æ–°ã—ã„ãƒãƒƒã‚¸ã‚’è§£é™¤ã—ã¾ã—ãŸ: ${newBadges.length}å€‹');
  }
}
```

### **å‹•ä½œãƒ•ãƒ­ãƒ¼:**
```
1. æ•£æ­©ã‚’è¨˜éŒ²ãƒ»ä¿å­˜
   â†“
2. ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«çµ±è¨ˆã‚’æ›´æ–°
   â†“
3. ãƒãƒƒã‚¸è§£é™¤æ¡ä»¶ã‚’ãƒã‚§ãƒƒã‚¯
   â†“
4. æ–°è¦ãƒãƒƒã‚¸ã‚’è§£é™¤
   â†“
5. ãƒ­ã‚°ã«å‡ºåŠ›
```

### **ãƒãƒƒã‚¸ç¨®é¡ï¼ˆ17ç¨®é¡å®šç¾©æ¸ˆã¿ï¼‰:**
- è·é›¢ç³»: 1km, 5km, 10km, 50km, 100km
- ã‚¨ãƒªã‚¢ç³»: 1ã‚¨ãƒªã‚¢, 3ã‚¨ãƒªã‚¢, 5ã‚¨ãƒªã‚¢
- ãƒ”ãƒ³ç³»: 1å€‹, 5å€‹, 10å€‹, 50å€‹
- ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ç³»: ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼10äºº, 50äºº, 100äºº
- ç‰¹åˆ¥ç³»: æ—©æœæ•£æ­©, å¤•æš®ã‚Œæ•£æ­©, é›¨ã®æ—¥æ•£æ­©

---

## ğŸ“¸ **å†™çœŸæ©Ÿèƒ½**

### **æ—¢å­˜å®Ÿè£…ï¼ˆç¢ºèªæ¸ˆã¿ï¼‰:**
- âœ… `walk-photos` Storage ãƒã‚±ãƒƒãƒˆ
- âœ… `walk_photos` ãƒ†ãƒ¼ãƒ–ãƒ«
- âœ… `PhotoService` (å®Œå…¨å®Ÿè£…)
- âœ… æ•£æ­©ä¸­ã®å†™çœŸæ’®å½±æ©Ÿèƒ½
- âœ… å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½

### **å®Ÿè£…æ¸ˆã¿æ©Ÿèƒ½:**
1. âœ… **ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã‹ã‚‰å†™çœŸé¸æŠ**
   - `pickImageFromGallery()`
   
2. âœ… **ã‚«ãƒ¡ãƒ©ã§å†™çœŸæ’®å½±**
   - `takePhoto()`
   - iOS Simulatorã§ã¯ã‚®ãƒ£ãƒ©ãƒªãƒ¼ä½¿ç”¨
   
3. âœ… **æ•£æ­©ä¸­ã®å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰**
   - `uploadWalkPhoto()`
   - Supabase Storage ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
   - `walk_photos` ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¨˜éŒ²
   - å…¬é–‹URLå–å¾—

### **ä½¿ç”¨ä¾‹:**
```dart
// Daily/Outing Walkç”»é¢ã§æ—¢ã«å®Ÿè£…æ¸ˆã¿
final file = await _photoService.takePhoto();
if (file != null) {
  final photoUrl = await _photoService.uploadWalkPhoto(
    file: file,
    walkId: walkId,
    userId: userId,
    displayOrder: i + 1,
  );
}
```

---

## ğŸ“ **ãƒ”ãƒ³æŠ•ç¨¿æ©Ÿèƒ½**

### **æ—¢å­˜å®Ÿè£…ï¼ˆç¢ºèªæ¸ˆã¿ï¼‰:**
- âœ… `route_pins` ãƒ†ãƒ¼ãƒ–ãƒ«
- âœ… `route_pin_photos` ãƒ†ãƒ¼ãƒ–ãƒ«
- âœ… `PinCreateScreen` (å®Œå…¨å®Ÿè£…)
- âœ… ãƒ”ãƒ³æŠ•ç¨¿UI

### **å®Ÿè£…æ¸ˆã¿æ©Ÿèƒ½:**
1. âœ… **ãƒ”ãƒ³ä½œæˆç”»é¢**
   - `lib/screens/outing/pin_create_screen.dart`
   - æ•£æ­©ä¸­ã«ç¾åœ¨ä½ç½®ã§ãƒ”ãƒ³æŠ•ç¨¿å¯èƒ½
   
2. âœ… **ãƒ”ãƒ³æŠ•ç¨¿ãƒœã‚¿ãƒ³**
   - Outing Walkç”»é¢ã«FloatingActionButton
   - ç¾åœ¨ä½ç½®ã§ãƒ”ãƒ³æŠ•ç¨¿
   
3. âœ… **ãƒ”ãƒ³ãƒ‡ãƒ¼ã‚¿ä¿å­˜**
   - `route_pins` ãƒ†ãƒ¼ãƒ–ãƒ«ã«ä¿å­˜
   - ã‚¿ã‚¤ãƒˆãƒ«ã€èª¬æ˜ã€ä½ç½®æƒ…å ±ã€å†™çœŸ

---

## ğŸ“Š **ä¿®æ­£ã‚µãƒãƒªãƒ¼**

| æ©Ÿèƒ½ | çŠ¶æ…‹ | ä¿®æ­£å†…å®¹ |
|------|------|---------|
| **Badgeæ©Ÿèƒ½** | âœ… å®Œäº† | è‡ªå‹•ãƒã‚§ãƒƒã‚¯è¿½åŠ  |
| **å†™çœŸæ©Ÿèƒ½** | âœ… å®Œäº† | æ—¢å­˜å®Ÿè£…ç¢ºèª |
| **ãƒ”ãƒ³æŠ•ç¨¿** | âœ… å®Œäº† | æ—¢å­˜å®Ÿè£…ç¢ºèª |

### **ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«:**
- `lib/screens/daily/daily_walking_screen.dart` (Badgeè‡ªå‹•ãƒã‚§ãƒƒã‚¯è¿½åŠ )
- `lib/screens/outing/walking_screen.dart` (Badgeè‡ªå‹•ãƒã‚§ãƒƒã‚¯è¿½åŠ )

### **ä¿®æ­£è¡Œæ•°:**
- 2ãƒ•ã‚¡ã‚¤ãƒ« Ã— 2ç®‡æ‰€ = 4ç®‡æ‰€ã®è¿½åŠ 

---

## ğŸ¯ **å‹•ä½œç¢ºèªé …ç›®**

### **Badgeæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ:**
1. âœ… æ•£æ­©ã‚’è¨˜éŒ²
2. âœ… ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«çµ±è¨ˆæ›´æ–°
3. âœ… ãƒãƒƒã‚¸ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
4. â³ æ–°è¦ãƒãƒƒã‚¸è§£é™¤ç¢ºèªï¼ˆæ¡ä»¶é”æˆæ™‚ï¼‰
5. â³ ãƒ­ã‚°å‡ºåŠ›ç¢ºèª

### **å†™çœŸæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ:**
1. âœ… æ•£æ­©ä¸­ã«å†™çœŸæ’®å½±ãƒœã‚¿ãƒ³ã‚¿ãƒƒãƒ—
2. âœ… ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã‹ã‚‰å†™çœŸé¸æŠ
3. âœ… å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
4. âœ… Storageä¿å­˜ç¢ºèª
5. âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨˜éŒ²ç¢ºèª

### **ãƒ”ãƒ³æŠ•ç¨¿ãƒ†ã‚¹ãƒˆ:**
1. âœ… Outing Walkä¸­ã«ãƒ”ãƒ³æŠ•ç¨¿ãƒœã‚¿ãƒ³ã‚¿ãƒƒãƒ—
2. âœ… ãƒ”ãƒ³ä½œæˆç”»é¢è¡¨ç¤º
3. âœ… ã‚¿ã‚¤ãƒˆãƒ«ãƒ»èª¬æ˜å…¥åŠ›
4. âœ… å†™çœŸæ·»ä»˜ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
5. âœ… æŠ•ç¨¿å®Œäº†

---

## ğŸ“ **å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§**

### **Badgeé–¢é€£:**
- `lib/models/badge.dart`
- `lib/services/badge_service.dart`
- `lib/providers/badge_provider.dart`
- `lib/widgets/badges/badge_card.dart`
- `lib/utils/badge_unlock_helper.dart`
- `supabase_migrations/008_phase5_badges_system.sql`

### **å†™çœŸé–¢é€£:**
- `lib/services/photo_service.dart`
- `walk-photos` Storage ãƒã‚±ãƒƒãƒˆ
- `walk_photos` ãƒ†ãƒ¼ãƒ–ãƒ«

### **ãƒ”ãƒ³é–¢é€£:**
- `lib/screens/outing/pin_create_screen.dart`
- `route_pins` ãƒ†ãƒ¼ãƒ–ãƒ«
- `route_pin_photos` ãƒ†ãƒ¼ãƒ–ãƒ«

---

## ğŸš€ **æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—**

### **Macå®Ÿæ©Ÿãƒ†ã‚¹ãƒˆ:**
1. `git pull origin main` ã§ã‚³ãƒ¼ãƒ‰å–å¾—
2. Flutter `R` ã‚­ãƒ¼ã§ãƒ›ãƒƒãƒˆãƒªã‚¹ã‚¿ãƒ¼ãƒˆ
3. æ•£æ­©ã‚’è¨˜éŒ²ã—ã¦ãƒãƒƒã‚¸ãƒã‚§ãƒƒã‚¯ãƒ­ã‚°ç¢ºèª
4. å†™çœŸæ’®å½±æ©Ÿèƒ½ç¢ºèª
5. ãƒ”ãƒ³æŠ•ç¨¿æ©Ÿèƒ½ç¢ºèª

### **æœŸå¾…ã•ã‚Œã‚‹ãƒ­ã‚°:**
```
flutter: âœ… æ—¥å¸¸æ•£æ­©è¨˜éŒ²ä¿å­˜æˆåŠŸ: walkId=xxx
flutter: ğŸ† æ–°ã—ã„ãƒãƒƒã‚¸ã‚’è§£é™¤ã—ã¾ã—ãŸ: 1å€‹  â† æ–°ã—ã„ãƒ­ã‚°
```

---

## ğŸ“ **æŠ€è¡“ãƒã‚¤ãƒ³ãƒˆ**

### **Badgeè‡ªå‹•ãƒã‚§ãƒƒã‚¯ã®å®Ÿè£…:**
```dart
// æ•£æ­©ä¿å­˜å¾Œã«è‡ªå‹•å®Ÿè¡Œ
final badgeService = BadgeService(Supabase.instance.client);
final newBadges = await badgeService.checkAndUnlockBadges(userId: userId);

// check_and_unlock_badges RPCé–¢æ•°ãŒå®Ÿè¡Œã•ã‚Œã‚‹
// â†’ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®çµ±è¨ˆæƒ…å ±ã‚’å–å¾—
// â†’ å„ãƒãƒƒã‚¸ã®æ¡ä»¶ã‚’ãƒã‚§ãƒƒã‚¯
// â†’ æ¡ä»¶é”æˆã—ãŸãƒãƒƒã‚¸ã‚’è§£é™¤
// â†’ æ–°è¦è§£é™¤ã•ã‚ŒãŸãƒãƒƒã‚¸IDã‚’è¿”å´
```

### **å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®æµã‚Œ:**
```dart
// 1. å†™çœŸé¸æŠ/æ’®å½±
final file = await _photoService.takePhoto();

// 2. Storageã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
await _supabase.storage.from('walk-photos').upload(filePath, file);

// 3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«è¨˜éŒ²
await _supabase.from('walk_photos').insert({...});

// 4. å…¬é–‹URLå–å¾—
final publicUrl = _supabase.storage.from('walk-photos').getPublicUrl(filePath);
```

---

## ğŸ“Š **çµ±è¨ˆ**

| é …ç›® | æ•°å€¤ |
|------|------|
| **ä½œæ¥­æ™‚é–“** | ç´„15åˆ† |
| **ç¢ºèªæ©Ÿèƒ½** | 3å€‹ |
| **ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«** | 2å€‹ |
| **è¿½åŠ ã‚³ãƒ¼ãƒ‰** | 4ç®‡æ‰€ |
| **æ—¢å­˜å®Ÿè£…** | å®Œç’§ |

---

## âœ… **çµè«–**

Badgeæ©Ÿèƒ½ã€å†™çœŸæ©Ÿèƒ½ã€ãƒ”ãƒ³æŠ•ç¨¿æ©Ÿèƒ½ã¯**æ—¢ã«ã»ã¼å®Œå…¨ã«å®Ÿè£…æ¸ˆã¿**ã§ã—ãŸã€‚

ä»Šå›ã®ä½œæ¥­ã§ã¯ï¼š
- âœ… Badgeè‡ªå‹•ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½ã‚’è¿½åŠ ï¼ˆæ•£æ­©ä¿å­˜å¾Œï¼‰
- âœ… æ—¢å­˜å®Ÿè£…ã®å®Œç’§ã•ã‚’ç¢ºèª
- âœ… å…¨æ©Ÿèƒ½ãŒå‹•ä½œå¯èƒ½ãªçŠ¶æ…‹

---

**ä½œæˆæ—¥:** 2025-11-27  
**æœ€çµ‚æ›´æ–°:** 2025-11-27  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:** âœ… Badgeè‡ªå‹•ãƒã‚§ãƒƒã‚¯è¿½åŠ å®Œäº†
